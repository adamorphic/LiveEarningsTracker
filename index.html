<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Earnings Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Earnings Tracker">
    <meta name="theme-color" content="#10b981">
    
    <!-- iOS icon -->
    <link rel="apple-touch-icon" href="android-chrome-192x192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js for PDF parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- React Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide icons as components
        const Clock = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>;
        const DollarSign = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const Target = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const TrendingUp = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22,7 13.5,15.5 8.5,10.5 2,17"/><polyline points="16,7 22,7 22,13"/></svg>;
        const Calendar = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Settings = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const X = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Download = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;

        const LiveEarningsTracker = () => {
          const [currentTime, setCurrentTime] = useState(new Date());
          const [view, setView] = useState('today');
          const [showSettings, setShowSettings] = useState(false);
          const [lastDollarAmount, setLastDollarAmount] = useState(0);
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showInstallPrompt, setShowInstallPrompt] = useState(false);
          const [parsedPayStub, setParsedPayStub] = useState(null);
          const [isParsingPDF, setIsParsingPDF] = useState(false);

          // User settings with localStorage
          const [settings, setSettings] = useState(() => {
            const savedSettings = localStorage.getItem('earningsTrackerSettings');
            if (savedSettings) {
              try {
                return JSON.parse(savedSettings);
              } catch (e) {
                console.log('Error loading saved settings:', e);
              }
            }
            return {
              hourlyRate: 19.20,
              workStartHour: 9,
              workStartMinute: 30,
              workEndHour: 18,
              workEndMinute: 30,
              lunchStartHour: 13,
              lunchStartMinute: 0,
              lunchEndHour: 14,
              lunchEndMinute: 0,
              payPeriodStartDate: '2025-08-07',
              payPeriodLength: 14,
              federalTaxRate: 12,
              stateTaxRate: 5,
              socialSecurityRate: 6.2,
              medicareRate: 1.45,
              otherDeductions: 0
            };
          });

          // Sound preference with localStorage
          const [soundEnabled, setSoundEnabled] = useState(() => {
            const savedSound = localStorage.getItem('earningsTrackerSound');
            return savedSound !== null ? JSON.parse(savedSound) : true;
          });

          const WORK_DAYS = [1, 2, 3, 4, 5];

          // Save settings to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('earningsTrackerSettings', JSON.stringify(settings));
          }, [settings]);

          // Save sound preference
          useEffect(() => {
            localStorage.setItem('earningsTrackerSound', JSON.stringify(soundEnabled));
          }, [soundEnabled]);

          // Update time every second
          useEffect(() => {
            const timer = setInterval(() => {
              setCurrentTime(new Date());
            }, 1000);
            return () => clearInterval(timer);
          }, []);

          // PWA Installation handling
          useEffect(() => {
            const handleBeforeInstallPrompt = (e) => {
              e.preventDefault();
              setDeferredPrompt(e);
              setShowInstallPrompt(true);
            };

            if (typeof window !== 'undefined') {
              window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            }

            return () => {
              if (typeof window !== 'undefined') {
                window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
              }
            };
          }, []);

          // Handle PWA installation
          const handleInstallClick = async () => {
            if (!deferredPrompt) {
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              if (isIOS) {
                alert('To install on iOS:\n1. Tap the Share button in Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to install the app');
              } else {
                alert('To install this app:\n1. Look for an install prompt in your browser\n2. Or check your browser menu for "Install App" option');
              }
              return;
            }

            try {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              
              if (outcome === 'accepted') {
                console.log('PWA installed');
              }
              
              setDeferredPrompt(null);
              setShowInstallPrompt(false);
            } catch (e) {
              console.log('Install failed:', e);
            }
          };

          // Parse PDF pay stub
          const parsePDFPayStub = async (file) => {
            setIsParsingPDF(true);
            try {
              // Set up PDF.js worker
              if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
              }

              const arrayBuffer = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
              
              let fullText = '';
              
              // Extract text from all pages
              for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + ' ';
              }
              
              console.log('Extracted PDF text:', fullText);
              
              // Parse the text for pay stub information
              const parsed = parsePayStubText(fullText);
              setParsedPayStub(parsed);
              
              return parsed;
            } catch (error) {
              console.error('PDF parsing error:', error);
              alert('Error parsing PDF. Please make sure it\'s a valid pay stub.');
              return null;
            } finally {
              setIsParsingPDF(false);
            }
          };

          // Parse pay stub text using regex patterns
          const parsePayStubText = (text) => {
            const parsed = {};
            
            // Convert to lowercase for easier matching
            const lowerText = text.toLowerCase();
            
            // Pattern for hourly rate (look for rate, hourly, /hr, per hour)
            const hourlyRatePatterns = [
              /(?:rate|hourly|\/hr|per\s*hour)[:\s]*\$?(\d+\.?\d*)/gi,
              /\$(\d+\.?\d*)\s*(?:\/\s*hr|per\s*hour|hourly)/gi,
              /regular\s*rate[:\s]*\$?(\d+\.?\d*)/gi,
              /base\s*rate[:\s]*\$?(\d+\.?\d*)/gi,
              /pay\s*rate[:\s]*\$?(\d+\.?\d*)/gi,
              // Look for patterns like "40.00 hrs @ $25.50"
              /(\d+\.?\d*)\s*hrs?\s*@\s*\$(\d+\.?\d*)/gi,
              /(\d+\.?\d*)\s*hours?\s*@\s*\$(\d+\.?\d*)/gi,
              // Look for rate in tables or structured data
              /\$(\d+\.?\d*)\s*\/\s*hr/gi,
              /hourly:\s*\$?(\d+\.?\d*)/gi
            ];
            
            for (const pattern of hourlyRatePatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                // For patterns that capture hours and rate separately
                if (match.length > 2 && match[2]) {
                  const rate = parseFloat(match[2]);
                  if (rate > 5 && rate < 200) {
                    parsed.hourlyRate = rate;
                    break;
                  }
                } else {
                  const rate = parseFloat(match[1]);
                  if (rate > 5 && rate < 200) {
                    parsed.hourlyRate = rate;
                    break;
                  }
                }
              }
              if (parsed.hourlyRate) break;
            }

            // More flexible patterns for federal tax
            const federalTaxPatterns = [
              /(?:federal|fed)\s*(?:tax|withholding|w\/h|income)[:\s]*\$?(\d+\.?\d*)/gi,
              /fed\s*tax[:\s]*\$?(\d+\.?\d*)/gi,
              /federal\s*income\s*tax[:\s]*\$?(\d+\.?\d*)/gi,
              /fit[:\s]*\$?(\d+\.?\d*)/gi, // Federal Income Tax abbreviation
              /federal[:\s]*\$?(\d+\.?\d*)/gi,
              /fed[:\s]*\$?(\d+\.?\d*)/gi,
              /us\s*tax[:\s]*\$?(\d+\.?\d*)/gi
            ];
            
            // More flexible patterns for gross pay
            const grossPayPatterns = [
              /(?:gross|total)\s*(?:pay|earnings|wages)[:\s]*\$?(\d+\.?\d*)/gi,
              /gross[:\s]*\$?(\d+\.?\d*)/gi,
              /total\s*earnings[:\s]*\$?(\d+\.?\d*)/gi,
              /total\s*wages[:\s]*\$?(\d+\.?\d*)/gi,
              /current\s*gross[:\s]*\$?(\d+\.?\d*)/gi,
              /period\s*gross[:\s]*\$?(\d+\.?\d*)/gi
            ];
            
            let grossPay = null;
            for (const pattern of grossPayPatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                const amount = parseFloat(match[1]);
                if (amount > 0 && amount < 50000) { // Reasonable gross pay range per period
                  grossPay = amount;
                  break;
                }
              }
              if (grossPay) break;
            }

            console.log('Found gross pay:', grossPay);

            // Extract federal tax amounts and calculate percentages
            for (const pattern of federalTaxPatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                const taxAmount = parseFloat(match[1]);
                if (taxAmount > 0 && grossPay && taxAmount < grossPay) {
                  const rate = ((taxAmount / grossPay) * 100);
                  if (rate > 0 && rate < 50) { // Reasonable tax rate
                    parsed.federalTaxRate = rate.toFixed(1);
                    break;
                  }
                }
              }
              if (parsed.federalTaxRate) break;
            }

            // More flexible state tax patterns
            const stateTaxPatterns = [
              /(?:state|st)\s*(?:tax|withholding|w\/h|income)[:\s]*\$?(\d+\.?\d*)/gi,
              /state\s*income\s*tax[:\s]*\$?(\d+\.?\d*)/gi,
              /sit[:\s]*\$?(\d+\.?\d*)/gi, // State Income Tax abbreviation
              /state[:\s]*\$?(\d+\.?\d*)/gi,
              /st\s*tax[:\s]*\$?(\d+\.?\d*)/gi
            ];
            
            for (const pattern of stateTaxPatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                const taxAmount = parseFloat(match[1]);
                if (taxAmount > 0 && grossPay && taxAmount < grossPay) {
                  const rate = ((taxAmount / grossPay) * 100);
                  if (rate > 0 && rate < 30) { // Reasonable state tax rate
                    parsed.stateTaxRate = rate.toFixed(1);
                    break;
                  }
                }
              }
              if (parsed.stateTaxRate) break;
            }

            // More flexible Social Security patterns
            const socialSecurityPatterns = [
              /(?:social\s*security|soc\s*sec|ss\s*tax|oasdi)[:\s]*\$?(\d+\.?\d*)/gi,
              /fica[:\s]*\$?(\d+\.?\d*)/gi,
              /ss[:\s]*\$?(\d+\.?\d*)/gi,
              /soc\s*sec[:\s]*\$?(\d+\.?\d*)/gi
            ];
            
            for (const pattern of socialSecurityPatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                const taxAmount = parseFloat(match[1]);
                if (taxAmount > 0 && grossPay && taxAmount < grossPay) {
                  const rate = ((taxAmount / grossPay) * 100);
                  if (rate > 4 && rate < 8) { // SS rate should be around 6.2%
                    parsed.socialSecurityRate = rate.toFixed(1);
                    break;
                  }
                }
              }
              if (parsed.socialSecurityRate) break;
            }

            // More flexible Medicare patterns
            const medicarePatterns = [
              /medicare[:\s]*\$?(\d+\.?\d*)/gi,
              /med\s*tax[:\s]*\$?(\d+\.?\d*)/gi,
              /medicare\s*tax[:\s]*\$?(\d+\.?\d*)/gi,
              /med[:\s]*\$?(\d+\.?\d*)/gi
            ];
            
            for (const pattern of medicarePatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                const taxAmount = parseFloat(match[1]);
                if (taxAmount > 0 && grossPay && taxAmount < grossPay) {
                  const rate = ((taxAmount / grossPay) * 100);
                  if (rate > 0.5 && rate < 3) { // Medicare rate should be around 1.45%
                    parsed.medicareRate = rate.toFixed(1);
                    break;
                  }
                }
              }
              if (parsed.medicareRate) break;
            }

            // More flexible deduction patterns
            const deductionPatterns = [
              /(?:401k|retirement|pension)[:\s]*\$?(\d+\.?\d*)/gi,
              /(?:health|medical|insurance|dental|vision)[:\s]*\$?(\d+\.?\d*)/gi,
              /(?:benefits|benefit)[:\s]*\$?(\d+\.?\d*)/gi,
              /(?:life\s*insurance|life\s*ins)[:\s]*\$?(\d+\.?\d*)/gi,
              /(?:parking|transit|commuter)[:\s]*\$?(\d+\.?\d*)/gi,
              /(?:union|dues)[:\s]*\$?(\d+\.?\d*)/gi
            ];
            
            let totalDeductions = 0;
            for (const pattern of deductionPatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                const amount = parseFloat(match[1]);
                if (amount > 0 && amount < 2000) { // Reasonable deduction range
                  totalDeductions += amount;
                }
              }
            }
            
            if (totalDeductions > 0) {
              parsed.otherDeductions = totalDeductions.toFixed(2);
            }

            // More flexible date patterns
            const datePatterns = [
              /(\d{1,2}\/\d{1,2}\/\d{4})\s*(?:to|-|through)\s*(\d{1,2}\/\d{1,2}\/\d{4})/gi,
              /(\d{4}-\d{2}-\d{2})\s*(?:to|-|through)\s*(\d{4}-\d{2}-\d{2})/gi,
              /pay\s*period[:\s]*(\d{1,2}\/\d{1,2}\/\d{4})\s*(?:to|-|through)\s*(\d{1,2}\/\d{1,2}\/\d{4})/gi,
              /period[:\s]*(\d{1,2}\/\d{1,2}\/\d{4})\s*(?:to|-|through)\s*(\d{1,2}\/\d{1,2}\/\d{4})/gi
            ];
            
            for (const pattern of datePatterns) {
              const matches = [...text.matchAll(pattern)];
              for (const match of matches) {
                try {
                  const startDate = new Date(match[1]);
                  const endDate = new Date(match[2]);
                  const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                  
                  if (daysDiff > 0 && daysDiff <= 31) {
                    parsed.payPeriodLength = daysDiff;
                    parsed.payPeriodStartDate = startDate.toISOString().split('T')[0];
                    break;
                  }
                } catch (e) {
                  console.log('Date parsing error:', e);
                }
              }
              if (parsed.payPeriodLength) break;
            }

            console.log('Parsed pay stub data:', parsed);
            return parsed;
          };

          // Handle file upload
          const handleFileUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
              alert('Please upload a PDF file.');
              return;
            }
            
            await parsePDFPayStub(file);
          };

          // Apply parsed data to settings
          const applyParsedData = () => {
            if (!parsedPayStub) return;
            
            const newSettings = { ...settings };
            
            if (parsedPayStub.hourlyRate) {
              newSettings.hourlyRate = parseFloat(parsedPayStub.hourlyRate);
            }
            if (parsedPayStub.federalTaxRate) {
              newSettings.federalTaxRate = parseFloat(parsedPayStub.federalTaxRate);
            }
            if (parsedPayStub.stateTaxRate) {
              newSettings.stateTaxRate = parseFloat(parsedPayStub.stateTaxRate);
            }
            if (parsedPayStub.socialSecurityRate) {
              newSettings.socialSecurityRate = parseFloat(parsedPayStub.socialSecurityRate);
            }
            if (parsedPayStub.medicareRate) {
              newSettings.medicareRate = parseFloat(parsedPayStub.medicareRate);
            }
            if (parsedPayStub.otherDeductions) {
              newSettings.otherDeductions = parseFloat(parsedPayStub.otherDeductions);
            }
            if (parsedPayStub.payPeriodLength) {
              newSettings.payPeriodLength = parseInt(parsedPayStub.payPeriodLength);
            }
            if (parsedPayStub.payPeriodStartDate) {
              newSettings.payPeriodStartDate = parsedPayStub.payPeriodStartDate;
            }
            
            setSettings(newSettings);
            setParsedPayStub(null);
            alert('Settings updated from pay stub!');
          };

          // Play cha-ching sound effect
          const playChaChing = () => {
            if (!soundEnabled) return;
            
            try {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              
              const playNote = (frequency, startTime, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
              };
              
              const now = audioContext.currentTime;
              playNote(523.25, now, 0.15);
              playNote(783.99, now + 0.1, 0.25);
              
            } catch (error) {
              console.log('Audio not supported');
            }
          };

          // Helper functions
          const isWorkDay = (date) => WORK_DAYS.includes(date.getDay());
          
          const isWorkTime = (date) => {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const currentMinutes = hours * 60 + minutes;
            
            const workStartMinutes = settings.workStartHour * 60 + settings.workStartMinute;
            const workEndMinutes = settings.workEndHour * 60 + settings.workEndMinute;
            const lunchStartMinutes = settings.lunchStartHour * 60 + settings.lunchStartMinute;
            const lunchEndMinutes = settings.lunchEndHour * 60 + settings.lunchEndMinute;
            
            return currentMinutes >= workStartMinutes && 
                   currentMinutes <= workEndMinutes && 
                   !(currentMinutes >= lunchStartMinutes && currentMinutes < lunchEndMinutes);
          };

          const getPayPeriodStart = (date) => {
            const startDate = new Date(settings.payPeriodStartDate);
            const daysDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
            const periodsSince = Math.floor(daysDiff / settings.payPeriodLength);
            const payPeriodStart = new Date(startDate);
            payPeriodStart.setDate(startDate.getDate() + (periodsSince * settings.payPeriodLength));
            payPeriodStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            return payPeriodStart;
          };

          const calculateEarnings = (startDate, endDate = currentTime) => {
            let totalMinutes = 0;
            const current = new Date(startDate);
            
            while (current <= endDate) {
              if (isWorkDay(current)) {
                const dayStart = new Date(current);
                dayStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
                
                const dayEnd = new Date(current);
                dayEnd.setHours(settings.workEndHour, settings.workEndMinute, 0, 0);
                
                const lunchStart = new Date(current);
                lunchStart.setHours(settings.lunchStartHour, settings.lunchStartMinute, 0, 0);
                
                const lunchEnd = new Date(current);
                lunchEnd.setHours(settings.lunchEndHour, settings.lunchEndMinute, 0, 0);
                
                const effectiveStart = current.toDateString() === endDate.toDateString() ? 
                  new Date(Math.max(dayStart, startDate, current)) : dayStart;
                const effectiveEnd = current.toDateString() === endDate.toDateString() ? 
                  new Date(Math.min(dayEnd, endDate)) : dayEnd;
                
                if (effectiveStart < effectiveEnd) {
                  let workMinutes = (effectiveEnd - effectiveStart) / (1000 * 60);
                  
                  if (effectiveStart <= lunchEnd && effectiveEnd >= lunchStart) {
                    const lunchOverlapStart = new Date(Math.max(effectiveStart, lunchStart));
                    const lunchOverlapEnd = new Date(Math.min(effectiveEnd, lunchEnd));
                    workMinutes -= (lunchOverlapEnd - lunchOverlapStart) / (1000 * 60);
                  }
                  
                  totalMinutes += Math.max(0, workMinutes);
                }
              }
              current.setDate(current.getDate() + 1);
              current.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            }
            
            return (totalMinutes / 60) * settings.hourlyRate;
          };

          const calculateAfterTaxEarnings = (grossEarnings) => {
            const totalTaxRate = (settings.federalTaxRate + settings.stateTaxRate + settings.socialSecurityRate + settings.medicareRate) / 100;
            const afterTaxEarnings = grossEarnings * (1 - totalTaxRate);
            return Math.max(0, afterTaxEarnings - (view === 'payPeriod' ? settings.otherDeductions : 0));
          };

          const getDateRanges = () => {
            const now = new Date(currentTime);
            const todayStart = new Date(now);
            todayStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            
            const weekStart = new Date(now);
            const daysFromMonday = (now.getDay() + 6) % 7;
            weekStart.setDate(now.getDate() - daysFromMonday);
            weekStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            
            const yearStart = new Date(now.getFullYear(), 0, 1);
            yearStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            
            const payPeriodStart = getPayPeriodStart(now);
            
            return { todayStart, weekStart, yearStart, payPeriodStart };
          };

          const { todayStart, weekStart, yearStart, payPeriodStart } = getDateRanges();
          
          const grossEarnings = {
            today: calculateEarnings(todayStart),
            week: calculateEarnings(weekStart),
            year: calculateEarnings(yearStart),
            payPeriod: calculateEarnings(payPeriodStart)
          };

          const afterTaxEarnings = {
            today: calculateAfterTaxEarnings(grossEarnings.today),
            week: calculateAfterTaxEarnings(grossEarnings.week),
            year: calculateAfterTaxEarnings(grossEarnings.year),
            payPeriod: calculateAfterTaxEarnings(grossEarnings.payPeriod)
          };

          const isCurrentlyEarning = isWorkDay(currentTime) && isWorkTime(currentTime);
          const earningsPerSecond = settings.hourlyRate / 3600;
          const afterTaxPerSecond = calculateAfterTaxEarnings(earningsPerSecond);

          // Check for dollar milestones and play sound
          useEffect(() => {
            const currentEarnings = afterTaxEarnings[view];
            const currentDollarAmount = Math.floor(currentEarnings);
            
            if (currentDollarAmount > lastDollarAmount && lastDollarAmount > 0 && isCurrentlyEarning) {
              playChaChing();
            }
            
            setLastDollarAmount(currentDollarAmount);
          }, [afterTaxEarnings, view, lastDollarAmount, isCurrentlyEarning, soundEnabled]);

          const handleSettingsChange = (field, value) => {
            setSettings(prev => ({
              ...prev,
              [field]: field === 'payPeriodStartDate' ? value : (parseFloat(value) || 0)
            }));
          };

          const formatCurrency = (amount) => `$${amount.toFixed(2)}`;
          
          const getViewLabel = () => {
            switch(view) {
              case 'today': return 'Today';
              case 'week': return 'This Week';
              case 'year': return 'This Year';
              case 'payPeriod': return 'This Pay Period';
              default: return '';
            }
          };

          const formatTime12Hour = (hour, minute) => {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
          };

          return (
            <div className="min-h-screen bg-gray-50" style={{fontFamily: '-apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, sans-serif'}}>
              <div className="max-w-sm mx-auto bg-white min-h-screen">
                {/* Status Bar Space */}
                <div className="h-12 bg-white"></div>
                
                {/* Header */}
                <div className="bg-white border-b border-gray-200 px-4 py-3">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className="text-2xl">ðŸ’°</div>
                      <div>
                        <h1 className="text-lg font-semibold text-black">Earnings</h1>
                        <p className="text-xs text-gray-500">Live Tracker</p>
                      </div>
                    </div>
                    <button
                      onClick={() => setShowSettings(!showSettings)}
                      className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"
                    >
                      <Settings size={18} className="text-gray-600" />
                    </button>
                  </div>
                </div>

                {/* Status Card */}
                <div className="mx-4 mt-4 bg-white rounded-xl shadow-sm border border-gray-200">
                  <div className="p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center space-x-2">
                        <div className={`w-2 h-2 rounded-full ${isCurrentlyEarning ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                        <span className="text-sm font-medium text-black">
                          {isCurrentlyEarning ? 'On the Clock' : 'Off the Clock'}
                        </span>
                      </div>
                      <button
                        onClick={() => setSoundEnabled(!soundEnabled)}
                        className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center"
                      >
                        <span className="text-sm">{soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡'}</span>
                      </button>
                    </div>
                    
                    {isCurrentlyEarning && (
                      <div className="space-y-1">
                        <div className="text-xs text-gray-500">
                          +{formatCurrency(afterTaxPerSecond)}/sec take-home
                        </div>
                        <div className="text-xs text-gray-500">
                          +{formatCurrency(earningsPerSecond)}/sec gross
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Time Period Selector */}
                <div className="mx-4 mt-4">
                  <div className="bg-gray-100 rounded-lg p-1 flex">
                    {[
                      { key: 'today', label: 'Today' },
                      { key: 'week', label: 'Week' },
                      { key: 'year', label: 'Year' },
                      { key: 'payPeriod', label: 'Period' }
                    ].map(({ key, label }) => (
                      <button
                        key={key}
                        onClick={() => setView(key)}
                        className={`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-all ${
                          view === key 
                            ? 'bg-white text-black shadow-sm' 
                            : 'text-gray-600'
                        }`}
                      >
                        {label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Earnings Cards */}
                <div className="mx-4 mt-4 space-y-3">
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div className="p-4">
                      <div className="text-xs text-gray-500 mb-1 uppercase font-medium tracking-wide">GROSS {getViewLabel().toUpperCase()}</div>
                      <div className="text-2xl font-bold text-black mb-1">
                        {formatCurrency(grossEarnings[view])}
                      </div>
                      <div className="text-xs text-gray-500">Before taxes & deductions</div>
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div className="p-4">
                      <div className="text-xs font-medium mb-1 uppercase tracking-wide" style={{color: '#007AFF'}}>TAKE-HOME {getViewLabel().toUpperCase()}</div>
                      <div className="text-2xl font-bold mb-1" style={{color: '#007AFF'}}>
                        {formatCurrency(afterTaxEarnings[view])}
                      </div>
                      <div className="text-xs text-gray-500">After taxes & deductions</div>
                    </div>
                  </div>
                </div>

                {/* Quick Stats */}
                <div className="mx-4 mt-4">
                  <div className="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div className="divide-y divide-gray-200">
                      <div className="p-4 flex justify-between items-center">
                        <div>
                          <div className="text-sm font-medium text-black">Hourly Rate</div>
                          <div className="text-xs text-gray-500">Gross pay</div>
                        </div>
                        <div className="text-sm font-semibold text-black">{formatCurrency(settings.hourlyRate)}</div>
                      </div>
                      
                      <div className="p-4 flex justify-between items-center">
                        <div>
                          <div className="text-sm font-medium text-black">Tax Rate</div>
                          <div className="text-xs text-gray-500">Total burden</div>
                        </div>
                        <div className="text-sm font-semibold text-black">
                          {(settings.federalTaxRate + settings.stateTaxRate + settings.socialSecurityRate + settings.medicareRate).toFixed(1)}%
                        </div>
                      </div>
                      
                      <div className="p-4 flex justify-between items-center">
                        <div>
                          <div className="text-sm font-medium text-black">Take-Home Rate</div>
                          <div className="text-xs text-gray-500">After taxes</div>
                        </div>
                        <div className="text-sm font-semibold" style={{color: '#007AFF'}}>
                          {formatCurrency(settings.hourlyRate * (1 - (settings.federalTaxRate + settings.stateTaxRate + settings.socialSecurityRate + settings.medicareRate) / 100))}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Current Time */}
                <div className="mx-4 mt-4 text-center">
                  <div className="text-xs text-gray-500">
                    {currentTime.toLocaleTimeString()}
                  </div>
                </div>

                {/* Settings Modal */}
                {showSettings && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
                    <div className="bg-white w-full rounded-t-2xl max-h-[85vh] overflow-hidden">
                      {/* Settings Header */}
                      <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
                        <button
                          onClick={() => setShowSettings(false)}
                          className="font-medium"
                          style={{color: '#007AFF'}}
                        >
                          Done
                        </button>
                        <h2 className="text-lg font-semibold text-black">Settings</h2>
                        <div className="w-12"></div>
                      </div>
                      
                      {/* Settings Content */}
                      <div className="overflow-y-auto max-h-[calc(85vh-60px)]">
                        <div className="p-4 space-y-6">
                          
                          {/* PDF Upload Section */}
                          <div>
                            <div className="text-xs text-gray-500 mb-3 uppercase font-medium tracking-wide">Import Pay Stub</div>
                            <div className="bg-white rounded-xl border border-gray-200">
                              <div className="p-4">
                                <div className="text-center">
                                  <div className="mb-3">
                                    <div className="text-sm font-medium text-black mb-1">Upload Pay Stub PDF</div>
                                    <div className="text-xs text-gray-500">Automatically detect rates and deductions</div>
                                  </div>
                                  
                                  <input
                                    type="file"
                                    accept=".pdf"
                                    onChange={handleFileUpload}
                                    disabled={isParsingPDF}
                                    className="hidden"
                                    id="pdf-upload"
                                  />
                                  
                                  <label
                                    htmlFor="pdf-upload"
                                    className={`inline-block px-4 py-2 rounded-lg font-medium cursor-pointer transition-colors ${
                                      isParsingPDF 
                                        ? 'bg-gray-100 text-gray-400' 
                                        : 'bg-blue-50 hover:bg-blue-100'
                                    }`}
                                    style={{color: isParsingPDF ? '#9CA3AF' : '#007AFF'}}
                                  >
                                    {isParsingPDF ? 'Parsing PDF...' : 'Choose PDF File'}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Parsed Data Preview */}
                          {parsedPayStub && (
                            <div>
                              <div className="text-xs text-gray-500 mb-3 uppercase font-medium tracking-wide">Detected Values</div>
                              <div className="bg-blue-50 rounded-xl border border-blue-200">
                                <div className="p-4">
                                  <div className="space-y-2 mb-4">
                                    {parsedPayStub.hourlyRate && (
                                      <div className="flex justify-between text-sm">
                                        <span>Hourly Rate:</span>
                                        <span className="font-medium">${parsedPayStub.hourlyRate}</span>
                                      </div>
                                    )}
                                    {parsedPayStub.federalTaxRate && (
                                      <div className="flex justify-between text-sm">
                                        <span>Federal Tax:</span>
                                        <span className="font-medium">{parsedPayStub.federalTaxRate}%</span>
                                      </div>
                                    )}
                                    {parsedPayStub.stateTaxRate && (
                                      <div className="flex justify-between text-sm">
                                        <span>State Tax:</span>
                                        <span className="font-medium">{parsedPayStub.stateTaxRate}%</span>
                                      </div>
                                    )}
                                    {parsedPayStub.socialSecurityRate && (
                                      <div className="flex justify-between text-sm">
                                        <span>Social Security:</span>
                                        <span className="font-medium">{parsedPayStub.socialSecurityRate}%</span>
                                      </div>
                                    )}
                                    {parsedPayStub.medicareRate && (
                                      <div className="flex justify-between text-sm">
                                        <span>Medicare:</span>
                                        <span className="font-medium">{parsedPayStub.medicareRate}%</span>
                                      </div>
                                    )}
                                    {parsedPayStub.otherDeductions && (
                                      <div className="flex justify-between text-sm">
                                        <span>Other Deductions:</span>
                                        <span className="font-medium">${parsedPayStub.otherDeductions}</span>
                                      </div>
                                    )}
                                    {parsedPayStub.payPeriodLength && (
                                      <div className="flex justify-between text-sm">
                                        <span>Pay Period:</span>
                                        <span className="font-medium">{parsedPayStub.payPeriodLength} days</span>
                                      </div>
                                    )}
                                  </div>
                                  
                                  <div className="flex space-x-3">
                                    <button
                                      onClick={applyParsedData}
                                      className="flex-1 py-2 px-4 rounded-lg font-medium text-white"
                                      style={{backgroundColor: '#007AFF'}}
                                    >
                                      Apply Values
                                    </button>
                                    <button
                                      onClick={() => setParsedPayStub(null)}
                                      className="flex-1 py-2 px-4 rounded-lg font-medium bg-gray-100 text-gray-600"
                                    >
                                      Cancel
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                          
                          {/* Work Settings Section */}
                          <div>
                            <div className="text-xs text-gray-500 mb-3 uppercase font-medium tracking-wide">Work Schedule</div>
                            <div className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div>
                                    <div className="text-sm font-medium text-black">Hourly Rate</div>
                                    <div className="text-xs text-gray-500">Gross pay per hour</div>
                                  </div>
                                  <input
                                    type="number"
                                    inputMode="decimal"
                                    step="0.01"
                                    value={settings.hourlyRate}
                                    onChange={(e) => handleSettingsChange('hourlyRate', e.target.value)}
                                    className="w-20 text-right bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                    placeholder="0.00"
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Work Start</div>
                                  <input
                                    type="time"
                                    value={`${settings.workStartHour.toString().padStart(2, '0')}:${settings.workStartMinute.toString().padStart(2, '0')}`}
                                    onChange={(e) => {
                                      const [hours, minutes] = e.target.value.split(':');
                                      handleSettingsChange('workStartHour', parseInt(hours));
                                      handleSettingsChange('workStartMinute', parseInt(minutes));
                                    }}
                                    className="bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Work End</div>
                                  <input
                                    type="time"
                                    value={`${settings.workEndHour.toString().padStart(2, '0')}:${settings.workEndMinute.toString().padStart(2, '0')}`}
                                    onChange={(e) => {
                                      const [hours, minutes] = e.target.value.split(':');
                                      handleSettingsChange('workEndHour', parseInt(hours));
                                      handleSettingsChange('workEndMinute', parseInt(minutes));
                                    }}
                                    className="bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Lunch Start</div>
                                  <input
                                    type="time"
                                    value={`${settings.lunchStartHour.toString().padStart(2, '0')}:${settings.lunchStartMinute.toString().padStart(2, '0')}`}
                                    onChange={(e) => {
                                      const [hours, minutes] = e.target.value.split(':');
                                      handleSettingsChange('lunchStartHour', parseInt(hours));
                                      handleSettingsChange('lunchStartMinute', parseInt(minutes));
                                    }}
                                    className="bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Lunch End</div>
                                  <input
                                    type="time"
                                    value={`${settings.lunchEndHour.toString().padStart(2, '0')}:${settings.lunchEndMinute.toString().padStart(2, '0')}`}
                                    onChange={(e) => {
                                      const [hours, minutes] = e.target.value.split(':');
                                      handleSettingsChange('lunchEndHour', parseInt(hours));
                                      handleSettingsChange('lunchEndMinute', parseInt(minutes));
                                    }}
                                    className="bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Pay Period Section */}
                          <div>
                            <div className="text-xs text-gray-500 mb-3 uppercase font-medium tracking-wide">Pay Period</div>
                            <div className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Start Date</div>
                                  <input
                                    type="date"
                                    value={settings.payPeriodStartDate}
                                    onChange={(e) => handleSettingsChange('payPeriodStartDate', e.target.value)}
                                    className="bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Length</div>
                                  <select
                                    value={settings.payPeriodLength}
                                    onChange={(e) => handleSettingsChange('payPeriodLength', e.target.value)}
                                    className="bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  >
                                    <option value={7}>Weekly</option>
                                    <option value={14}>Bi-weekly</option>
                                    <option value={15}>Semi-monthly</option>
                                    <option value={30}>Monthly</option>
                                  </select>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Tax Settings Section */}
                          <div>
                            <div className="text-xs text-gray-500 mb-3 uppercase font-medium tracking-wide">Tax Rates (%)</div>
                            <div className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Federal Tax</div>
                                  <input
                                    type="number"
                                    inputMode="decimal"
                                    step="0.1"
                                    min="0"
                                    max="100"
                                    value={settings.federalTaxRate}
                                    onChange={(e) => handleSettingsChange('federalTaxRate', e.target.value)}
                                    className="w-16 text-right bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">State Tax</div>
                                  <input
                                    type="number"
                                    inputMode="decimal"
                                    step="0.1"
                                    min="0"
                                    max="100"
                                    value={settings.stateTaxRate}
                                    onChange={(e) => handleSettingsChange('stateTaxRate', e.target.value)}
                                    className="w-16 text-right bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Social Security</div>
                                  <input
                                    type="number"
                                    inputMode="decimal"
                                    step="0.1"
                                    min="0"
                                    max="100"
                                    value={settings.socialSecurityRate}
                                    onChange={(e) => handleSettingsChange('socialSecurityRate', e.target.value)}
                                    className="w-16 text-right bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                              
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div className="text-sm font-medium text-black">Medicare</div>
                                  <input
                                    type="number"
                                    inputMode="decimal"
                                    step="0.1"
                                    min="0"
                                    max="100"
                                    value={settings.medicareRate}
                                    onChange={(e) => handleSettingsChange('medicareRate', e.target.value)}
                                    className="w-16 text-right bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                  />
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Deductions Section */}
                          <div className="pb-8">
                            <div className="text-xs text-gray-500 mb-3 uppercase font-medium tracking-wide">Deductions</div>
                            <div className="bg-white rounded-xl border border-gray-200">
                              <div className="p-4">
                                <div className="flex justify-between items-center">
                                  <div>
                                    <div className="text-sm font-medium text-black">Other Deductions</div>
                                    <div className="text-xs text-gray-500">Per pay period</div>
                                  </div>
                                  <input
                                    type="number"
                                    inputMode="decimal"
                                    step="0.01"
                                    value={settings.otherDeductions}
                                    onChange={(e) => handleSettingsChange('otherDeductions', e.target.value)}
                                    className="w-20 text-right bg-transparent font-medium border-none outline-none"
                                    style={{color: '#007AFF'}}
                                    placeholder="0.00"
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Bottom Safe Area */}
                <div className="h-8"></div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<LiveEarningsTracker />, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
