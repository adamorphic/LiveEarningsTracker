<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Earnings Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS PWA meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Earnings Tracker">
    <meta name="theme-color" content="#10b981">
    
    <!-- iOS icon -->
    <link rel="apple-touch-icon" href="android-chrome-192x192.png">
    
    <!-- Tailwind CSS with custom Apple styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'ios-blue': '#007AFF',
              'ios-gray': '#F2F2F7',
              'ios-gray-dark': '#8E8E93',
              'ios-green': '#34C759',
              'ios-red': '#FF3B30',
              'ios-orange': '#FF9500',
              'ios-purple': '#AF52DE',
              'ios-system-bg': '#FFFFFF',
              'ios-secondary-bg': '#F2F2F7',
              'ios-tertiary-bg': '#FFFFFF',
              'ios-separator': '#C6C6C8'
            },
            fontFamily: {
              'sf': ['-apple-system', 'BlinkMacSystemFont', 'SF Pro Display', 'SF Pro Text', 'system-ui', 'sans-serif']
            },
            borderRadius: {
              'ios': '10px',
              'ios-lg': '16px'
            }
          }
        }
      }
    </script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <!-- React Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide icons as components
        const Clock = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>;
        const DollarSign = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>;
        const Target = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const TrendingUp = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22,7 13.5,15.5 8.5,10.5 2,17"/><polyline points="16,7 22,7 22,13"/></svg>;
        const Calendar = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const Settings = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const X = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Download = ({size = 24}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;

        const LiveEarningsTracker = () => {
          const [currentTime, setCurrentTime] = useState(new Date());
          const [view, setView] = useState('today');
          const [showSettings, setShowSettings] = useState(false);
          const [lastDollarAmount, setLastDollarAmount] = useState(0);
          const [deferredPrompt, setDeferredPrompt] = useState(null);
          const [showInstallPrompt, setShowInstallPrompt] = useState(false);

          // User settings with localStorage
          const [settings, setSettings] = useState(() => {
            const savedSettings = localStorage.getItem('earningsTrackerSettings');
            if (savedSettings) {
              try {
                return JSON.parse(savedSettings);
              } catch (e) {
                console.log('Error loading saved settings:', e);
              }
            }
            return {
              hourlyRate: 19.20,
              workStartHour: 9,
              workStartMinute: 30,
              workEndHour: 18,
              workEndMinute: 30,
              lunchStartHour: 13,
              lunchStartMinute: 0,
              lunchEndHour: 14,
              lunchEndMinute: 0,
              payPeriodStartDate: '2025-08-07',
              payPeriodLength: 14,
              federalTaxRate: 12,
              stateTaxRate: 5,
              socialSecurityRate: 6.2,
              medicareRate: 1.45,
              otherDeductions: 0
            };
          });

          // Sound preference with localStorage
          const [soundEnabled, setSoundEnabled] = useState(() => {
            const savedSound = localStorage.getItem('earningsTrackerSound');
            return savedSound !== null ? JSON.parse(savedSound) : true;
          });

          const WORK_DAYS = [1, 2, 3, 4, 5];

          // Save settings to localStorage whenever they change
          useEffect(() => {
            localStorage.setItem('earningsTrackerSettings', JSON.stringify(settings));
          }, [settings]);

          // Save sound preference
          useEffect(() => {
            localStorage.setItem('earningsTrackerSound', JSON.stringify(soundEnabled));
          }, [soundEnabled]);

          // Update time every second
          useEffect(() => {
            const timer = setInterval(() => {
              setCurrentTime(new Date());
            }, 1000);
            return () => clearInterval(timer);
          }, []);

          // PWA Installation handling
          useEffect(() => {
            const handleBeforeInstallPrompt = (e) => {
              e.preventDefault();
              setDeferredPrompt(e);
              setShowInstallPrompt(true);
            };

            if (typeof window !== 'undefined') {
              window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
            }

            return () => {
              if (typeof window !== 'undefined') {
                window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
              }
            };
          }, []);

          // Handle PWA installation
          const handleInstallClick = async () => {
            if (!deferredPrompt) {
              const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
              if (isIOS) {
                alert('To install on iOS:\n1. Tap the Share button in Safari\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to install the app');
              } else {
                alert('To install this app:\n1. Look for an install prompt in your browser\n2. Or check your browser menu for "Install App" option');
              }
              return;
            }

            try {
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              
              if (outcome === 'accepted') {
                console.log('PWA installed');
              }
              
              setDeferredPrompt(null);
              setShowInstallPrompt(false);
            } catch (e) {
              console.log('Install failed:', e);
            }
          };

          // Play cha-ching sound effect
          const playChaChing = () => {
            if (!soundEnabled) return;
            
            try {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              
              const playNote = (frequency, startTime, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
              };
              
              const now = audioContext.currentTime;
              playNote(523.25, now, 0.15);
              playNote(783.99, now + 0.1, 0.25);
              
            } catch (error) {
              console.log('Audio not supported');
            }
          };

          // Helper functions
          const isWorkDay = (date) => WORK_DAYS.includes(date.getDay());
          
          const isWorkTime = (date) => {
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const currentMinutes = hours * 60 + minutes;
            
            const workStartMinutes = settings.workStartHour * 60 + settings.workStartMinute;
            const workEndMinutes = settings.workEndHour * 60 + settings.workEndMinute;
            const lunchStartMinutes = settings.lunchStartHour * 60 + settings.lunchStartMinute;
            const lunchEndMinutes = settings.lunchEndHour * 60 + settings.lunchEndMinute;
            
            return currentMinutes >= workStartMinutes && 
                   currentMinutes <= workEndMinutes && 
                   !(currentMinutes >= lunchStartMinutes && currentMinutes < lunchEndMinutes);
          };

          const getPayPeriodStart = (date) => {
            const startDate = new Date(settings.payPeriodStartDate);
            const daysDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
            const periodsSince = Math.floor(daysDiff / settings.payPeriodLength);
            const payPeriodStart = new Date(startDate);
            payPeriodStart.setDate(startDate.getDate() + (periodsSince * settings.payPeriodLength));
            payPeriodStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            return payPeriodStart;
          };

          const calculateEarnings = (startDate, endDate = currentTime) => {
            let totalMinutes = 0;
            const current = new Date(startDate);
            
            while (current <= endDate) {
              if (isWorkDay(current)) {
                const dayStart = new Date(current);
                dayStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
                
                const dayEnd = new Date(current);
                dayEnd.setHours(settings.workEndHour, settings.workEndMinute, 0, 0);
                
                const lunchStart = new Date(current);
                lunchStart.setHours(settings.lunchStartHour, settings.lunchStartMinute, 0, 0);
                
                const lunchEnd = new Date(current);
                lunchEnd.setHours(settings.lunchEndHour, settings.lunchEndMinute, 0, 0);
                
                const effectiveStart = current.toDateString() === endDate.toDateString() ? 
                  new Date(Math.max(dayStart, startDate, current)) : dayStart;
                const effectiveEnd = current.toDateString() === endDate.toDateString() ? 
                  new Date(Math.min(dayEnd, endDate)) : dayEnd;
                
                if (effectiveStart < effectiveEnd) {
                  let workMinutes = (effectiveEnd - effectiveStart) / (1000 * 60);
                  
                  if (effectiveStart <= lunchEnd && effectiveEnd >= lunchStart) {
                    const lunchOverlapStart = new Date(Math.max(effectiveStart, lunchStart));
                    const lunchOverlapEnd = new Date(Math.min(effectiveEnd, lunchEnd));
                    workMinutes -= (lunchOverlapEnd - lunchOverlapStart) / (1000 * 60);
                  }
                  
                  totalMinutes += Math.max(0, workMinutes);
                }
              }
              current.setDate(current.getDate() + 1);
              current.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            }
            
            return (totalMinutes / 60) * settings.hourlyRate;
          };

          const calculateAfterTaxEarnings = (grossEarnings) => {
            const totalTaxRate = (settings.federalTaxRate + settings.stateTaxRate + settings.socialSecurityRate + settings.medicareRate) / 100;
            const afterTaxEarnings = grossEarnings * (1 - totalTaxRate);
            return Math.max(0, afterTaxEarnings - (view === 'payPeriod' ? settings.otherDeductions : 0));
          };

          const getDateRanges = () => {
            const now = new Date(currentTime);
            const todayStart = new Date(now);
            todayStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            
            const weekStart = new Date(now);
            const daysFromMonday = (now.getDay() + 6) % 7;
            weekStart.setDate(now.getDate() - daysFromMonday);
            weekStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            
            const yearStart = new Date(now.getFullYear(), 0, 1);
            yearStart.setHours(settings.workStartHour, settings.workStartMinute, 0, 0);
            
            const payPeriodStart = getPayPeriodStart(now);
            
            return { todayStart, weekStart, yearStart, payPeriodStart };
          };

          const { todayStart, weekStart, yearStart, payPeriodStart } = getDateRanges();
          
          const grossEarnings = {
            today: calculateEarnings(todayStart),
            week: calculateEarnings(weekStart),
            year: calculateEarnings(yearStart),
            payPeriod: calculateEarnings(payPeriodStart)
          };

          const afterTaxEarnings = {
            today: calculateAfterTaxEarnings(grossEarnings.today),
            week: calculateAfterTaxEarnings(grossEarnings.week),
            year: calculateAfterTaxEarnings(grossEarnings.year),
            payPeriod: calculateAfterTaxEarnings(grossEarnings.payPeriod)
          };

          const isCurrentlyEarning = isWorkDay(currentTime) && isWorkTime(currentTime);
          const earningsPerSecond = settings.hourlyRate / 3600;
          const afterTaxPerSecond = calculateAfterTaxEarnings(earningsPerSecond);

          // Check for dollar milestones and play sound
          useEffect(() => {
            const currentEarnings = afterTaxEarnings[view];
            const currentDollarAmount = Math.floor(currentEarnings);
            
            if (currentDollarAmount > lastDollarAmount && lastDollarAmount > 0 && isCurrentlyEarning) {
              playChaChing();
            }
            
            setLastDollarAmount(currentDollarAmount);
          }, [afterTaxEarnings, view, lastDollarAmount, isCurrentlyEarning, soundEnabled]);

          const handleSettingsChange = (field, value) => {
            setSettings(prev => ({
              ...prev,
              [field]: field === 'payPeriodStartDate' ? value : (parseFloat(value) || 0)
            }));
          };

          const formatCurrency = (amount) => `$${amount.toFixed(2)}`;
          
          const getViewLabel = () => {
            switch(view) {
              case 'today': return 'Today';
              case 'week': return 'This Week';
              case 'year': return 'This Year';
              case 'payPeriod': return 'This Pay Period';
              default: return '';
            }
          };

          const formatTime12Hour = (hour, minute) => {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${period}`;
          };

          return (
            <div className="min-h-screen bg-ios-secondary-bg font-sf">
              <div className="max-w-md mx-auto bg-ios-system-bg">
                {/* Status Bar Space */}
                <div className="h-12"></div>
                
                {/* Navigation Header */}
                <div className="bg-ios-system-bg border-b border-ios-separator px-4 py-3">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className="text-2xl">ðŸ’°</div>
                      <div>
                        <h1 className="text-lg font-semibold text-black">Earnings</h1>
                        <p className="text-xs text-ios-gray-dark">Live Tracker</p>
                      </div>
                    </div>
                    <button
                      onClick={() => setShowSettings(!showSettings)}
                      className="w-8 h-8 rounded-full bg-ios-gray flex items-center justify-center"
                    >
                      <Settings size={18} className="text-ios-gray-dark" />
                    </button>
                  </div>
                </div>

                {/* Status Card */}
                <div className="mx-4 mt-4 bg-ios-system-bg rounded-ios-lg shadow-sm border border-ios-separator">
                  <div className="p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center space-x-2">
                        <div className={`w-2 h-2 rounded-full ${isCurrentlyEarning ? 'bg-ios-green' : 'bg-ios-gray-dark'}`}></div>
                        <span className="text-sm font-medium text-black">
                          {isCurrentlyEarning ? 'On the Clock' : 'Off the Clock'}
                        </span>
                      </div>
                      <button
                        onClick={() => setSoundEnabled(!soundEnabled)}
                        className="w-8 h-8 rounded-full bg-ios-gray flex items-center justify-center"
                      >
                        <span className="text-sm">{soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡'}</span>
                      </button>
                    </div>
                    
                    {isCurrentlyEarning && (
                      <div className="space-y-1">
                        <div className="text-xs text-ios-gray-dark">
                          +{formatCurrency(afterTaxPerSecond)}/sec take-home
                        </div>
                        <div className="text-xs text-ios-gray-dark">
                          +{formatCurrency(earningsPerSecond)}/sec gross
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Time Period Selector */}
                <div className="mx-4 mt-4">
                  <div className="bg-ios-gray rounded-ios p-1 flex">
                    {[
                      { key: 'today', label: 'Today' },
                      { key: 'week', label: 'Week' },
                      { key: 'year', label: 'Year' },
                      { key: 'payPeriod', label: 'Period' }
                    ].map(({ key, label }) => (
                      <button
                        key={key}
                        onClick={() => setView(key)}
                        className={`flex-1 py-2 px-3 rounded-lg text-sm font-medium transition-all ${
                          view === key 
                            ? 'bg-ios-system-bg text-black shadow-sm' 
                            : 'text-ios-gray-dark'
                        }`}
                      >
                        {label}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Earnings Cards */}
                <div className="mx-4 mt-4 space-y-3">
                  <div className="bg-ios-system-bg rounded-ios-lg shadow-sm border border-ios-separator">
                    <div className="p-4">
                      <div className="text-xs text-ios-gray-dark mb-1">GROSS {getViewLabel().toUpperCase()}</div>
                      <div className="text-2xl font-bold text-black mb-1">
                        {formatCurrency(grossEarnings[view])}
                      </div>
                      <div className="text-xs text-ios-gray-dark">Before taxes & deductions</div>
                    </div>
                  </div>

                  <div className="bg-ios-system-bg rounded-ios-lg shadow-sm border border-ios-separator">
                    <div className="p-4">
                      <div className="text-xs text-ios-blue font-medium mb-1">TAKE-HOME {getViewLabel().toUpperCase()}</div>
                      <div className="text-2xl font-bold text-ios-blue mb-1">
                        {formatCurrency(afterTaxEarnings[view])}
                      </div>
                      <div className="text-xs text-ios-gray-dark">After taxes & deductions</div>
                    </div>
                  </div>
                </div>

                {/* Quick Stats */}
                <div className="mx-4 mt-4">
                  <div className="bg-ios-system-bg rounded-ios-lg shadow-sm border border-ios-separator">
                    <div className="divide-y divide-ios-separator">
                      <div className="p-4 flex justify-between items-center">
                        <div>
                          <div className="text-sm font-medium text-black">Hourly Rate</div>
                          <div className="text-xs text-ios-gray-dark">Gross pay</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-black">{formatCurrency(settings.hourlyRate)}</div>
                        </div>
                      </div>
                      
                      <div className="p-4 flex justify-between items-center">
                        <div>
                          <div className="text-sm font-medium text-black">Tax Rate</div>
                          <div className="text-xs text-ios-gray-dark">Total burden</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-black">
                            {(settings.federalTaxRate + settings.stateTaxRate + settings.socialSecurityRate + settings.medicareRate).toFixed(1)}%
                          </div>
                        </div>
                      </div>
                      
                      <div className="p-4 flex justify-between items-center">
                        <div>
                          <div className="text-sm font-medium text-black">Take-Home Rate</div>
                          <div className="text-xs text-ios-gray-dark">After taxes</div>
                        </div>
                        <div className="text-right">
                          <div className="text-sm font-semibold text-ios-blue">
                            {formatCurrency(settings.hourlyRate * (1 - (settings.federalTaxRate + settings.stateTaxRate + settings.socialSecurityRate + settings.medicareRate) / 100))}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Current Time */}
                <div className="mx-4 mt-4 text-center">
                  <div className="text-xs text-ios-gray-dark">
                    {currentTime.toLocaleTimeString()}
                  </div>
                </div>

                {/* Bottom Safe Area */}
                <div className="h-8"></div>
          );
        };

        ReactDOM.render(<LiveEarningsTracker />, document.getElementById('root'));
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
